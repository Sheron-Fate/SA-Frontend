package repository

import (
	"strconv"
	"strings"
	"time"

	"colorLex/internal/app"
)

// Services slice (коллекция услуг)
var services = []app.Service{
	{
		ID:          "s1",
		Name:        "Ультрамарин",
		Brief:       `Драгоценный пигмент, получаемый из минерала лазурита.`,
		Description: `Драгоценный пигмент, получаемый из минерала лазурита. Широко использовался в эпоху Возрождения для изображения одежд Девы Марии, был дороже золота.`,
		Color:       `Яркий, глубокий синий.`,
		Specs:       `Поглощает в красно-желтой и оранжевой областях спектра (длины волн ~580-700 нм). Имеет два характерных пика поглощения в районе ~600 нм и ~650 нм. Сильно отражает синий и фиолетовый свет (~400-500 нм).`,
		ImageKey:    "ultramarine.jpg",
	},
	{
		ID:          "s2",
		Name:        "Киноварь",
		Brief:       `Ярко-красный пигмент на основе сульфида ртути (HgS)`,
		Description: `История: Ярко-красный пигмент на основе сульфида ртути (HgS). Использовался с античных времен, очень популярен в средневековых манускриптах и живописи.`,
		Color:       `Ярко-алый, красный.`,
		Specs:       `Поглощает коротковолновую часть видимого спектра — синий, зеленый и желтый свет (~400-580 нм). Максимум отражения (и, следовательно, цвета) приходится на длинноволновую красную область (~620-750 нм).`,
		ImageKey:    "Vermillion.jpg",
	},
	{
		ID:          "s3",
		Name:        "Свинцовые белила",
		Brief:       `Один из древнейших и самых важных белых пигментов`,
		Description: `История: Один из древнейших и самых важных белых пигментов (основной карбонат свинца 2PbCO₃·Pb(OH)₂). Использовался повсеместно до XX века, когда был запрещен из-за токсичности.`,
		Color:       `Белый.`,
		Specs:       `Не имеет выраженных пиков поглощения в видимой области. Равномерно и эффективно рассеивает весь видимый свет (~400-700 нм), что и создает ощущение белого цвета.`,
		ImageKey:    "PlumbumWhite.jpg",
	},
	{
		ID:          "s4",
		Name:        "Охра желтая",
		Brief:       `Природная глина, окрашенная гидратированным оксидом железа`,
		Description: `История: Один из первых пигментов, используемых человечеством (наскальная живопись). Природная глина, окрашенная гидратированным оксидом железа (FeO(OH)·nH₂O).`,
		Color:       `Желтый, землистый.`,
		Specs:       `Поглощает в синей и фиолетовой частях спектра (~400-500 нм). Отражает желтый, оранжевый и красный свет (~550-700 нм). Спектр плавно rising от синей области к красной.`,
		ImageKey:    "YellowOhra.jpg",
	},
	{
		ID:          "s5",
		Name:        "Охра красная",
		Brief:       `Обожженная желтая охра`,
		Description: `История: Обожженная желтая охра. При прокаливании гидратированный оксид железа теряет воду и превращается в красный оксид железа (Fe₂O₃).`,
		Color:       `Красно-коричневый.`,
		Specs:       `Поглощает в сине-зеленой области (~400-550 нм). Максимум отражения смещен в сторону длинных волн — оранжевый и красный свет (~600-700 нм).`,
		ImageKey:    "redOhra.jpg",
	},
	{
		ID:          "s6",
		Name:        "Малахит",
		Brief:       `Природный минерал, основной карбонат меди Cu₂CO₃(OH)₂`,
		Description: `История: Природный минерал, основной карбонат меди Cu₂CO₃(OH)₂. Использовался в Древнем Египте и средневековой Европе.`,
		Color:       `Зеленый, от насыщенного до приглушенного.`,
		Specs:       `Поглощает в красно-оранжевой области спектра (центр поглощения ~600-700 нм) и частично в синей. Сильнее всего отражает свет в зеленой области (~500-570 нм).`,
		ImageKey:    "malahite.jpg",
	},
	{
		ID:          "s7",
		Name:        "Индиго",
		Brief:       `Органический пигмент, добываемый из растений рода Indigofera`,
		Description: `История: Органический пигмент, добываемый из растений рода Indigofera. Использовался для окраски тканей и в живописи.`,
		Color:       `Темно-синий.`,
		Specs:       `Имеет широкую полосу поглощения в оранжево-красной области спектра с максимумом ~660 нм и еще одну полосу в желто-зеленой (~610 нм). Отражает синий и фиолетовый свет.`,
		ImageKey:    "Indigo.jpg",
	},
	{
		ID:          "s8",
		Name:        "Свинцовый сурик",
		Brief:       `Яркий оранжево-красный пигмент (оксид свинца Pb₃O₄)`,
		Description: `История: Яркий оранжево-красный пигмент (оксид свинца Pb₃O₄). Использовался со времен античности для защитной окраски металлических конструкций и в живописи.`,
		Color:       `Ярко-оранжевый, красный.`,
		Specs:       `Сильно поглощает синий и зеленый свет (~400-550 нм). Отражает оранжевый и красный свет (~580-700 нм).`,
		ImageKey:    "surik.jpg",
	},
	{
		ID:          "s9",
		Name:        "Костная чернь",
		Brief:       `Получается путем обжига животной кости в условиях недостатка воздуха`,
		Description: `История: Получается путем обжига животной кости в условиях недостатка воздуха. Состоит в основном из углерода. Широко использовалась в графике и живописи.`,
		Color:       `Черный, с коричневатым или синеватым подтоном.`,
		Specs:       `Поглощает практически весь падающий видимый свет равномерно по всему спектру (от ~400 до 700 нм). Степень поглощения очень высокая, что и дает глубокий черный цвет. Небольшие вариации в оттенке зависят от размера частиц и примесей.`,
		ImageKey:    "chern.jpg",
	},
}

var applications = map[string]app.Application{
	"app1": {
		ID:         "app1",
		Owner:      "Егор Уфимцев",
		Created:    time.Now(),
		ServiceIDs: []string{"s1", "s2", "s8"},
		Notes:      "Анализ выцветшей фрагментации на стене…",
	},
}

func FilterServices(q string) []app.Service {
	if q == "" {
		return services
	}
	var out []app.Service
	for _, s := range services {
		match := false
		if strings.Contains(strings.ToLower(s.Name), strings.ToLower(q)) {
			match = true
		}
		if !match {
			if p, err := strconv.ParseFloat(q, 64); err == nil && s.Price == p {
				match = true
			}
		}
		if !match {
			if t, err := time.Parse("2006-01-02", q); err == nil &&
				s.Date.Format("2006-01-02") == t.Format("2006-01-02") {
				match = true
			}
		}
		if match {
			out = append(out, s)
		}
	}
	return out
}

func GetService(id string) *app.Service {
	for _, s := range services {
		if s.ID == id {
			return &s
		}
	}
	return nil
}

func GetApplication(id string) *app.Application {
	if a, ok := applications[id]; ok {
		return &a
	}
	return nil
}

func ApplicationServiceCount(id string) int {
	if a, ok := applications[id]; ok {
		return len(a.ServiceIDs)
	}
	return 0
}

func GetServicesByIDs(ids []string) []app.Service {
	var result []app.Service
	for _, id := range ids {
		for _, s := range services {
			if s.ID == id {
				result = append(result, s)
				break
			}
		}
	}
	return result
}
